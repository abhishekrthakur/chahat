@model TaskManagmentSystem.DTO.TaskListDTO
<style>
    .status-dropdown.status-approved {
        background-color: #d4edda;
        color: #155724;
        border-color: #c3e6cb;
    }

    .status-dropdown.status-pending {
        background-color: #f8d7da;
        color: #721c24;
        border-color: #f5c6cb;
    }
</style>


<div class="form-group">
    <h2 style="margin-top:10px">Attendance History</h2>
    <label for="userDropdown">Select User</label>
    <select id="userDropdown" class="form-control">
        <option value="">-- Select Member --</option>
        @foreach (var user in Model.Members)
        {
            <option value="@user.UserId">@user.Username</option>
        }
    </select>
</div>

<div id="attendanceContainer">
    <!-- AJAX-loaded attendance content will go here -->
</div>

<script>
    function formatTotalTime(timeString) {
        if (!timeString) return "-";

        const parts = timeString.split(':');
        const hours = parseInt(parts[0]);
        const minutes = parseInt(parts[1]);

        return `${hours}h ${minutes}m`;
    }

    $(document).ready(function () {
        $('#userDropdown').change(function () {
            var selectedUserId = $(this).val();
            if (selectedUserId) {
                $.ajax({
                    url: '/Employee/GetAttendanceByUser',
                    type: 'GET',
                    data: { userId: selectedUserId },
                    success: function (data) {
                        var html = '';
                        if (data && data.length > 0) {
                            html += '<table class="table table-striped table-bordered">';
                            html += '<thead><tr>' +
                                '<th>Date</th>' +
                                '<th>Day</th>' +
                                '<th>In Time</th>' +
                                '<th>Out Time</th>' +
                                '<th>Total Time</th>' +
                                '<th>Status</th>' +
                                '</tr></thead>';
                            html += '<tbody>';

                            data.forEach(function (attendance) {
                                var statusClass = attendance.status === 'Approved' ? 'status-approved' : 'status-pending';

                                html += '<tr data-id="' + attendance.id + '">' +
                                    '<td>' + formatDate(attendance.date) + '</td>' +
                                    '<td>' + attendance.day + '</td>' +
                                    '<td>' + formatTime(attendance.inTime) + '</td>' +
                                    '<td>' + formatTime(attendance.outTIme) + '</td>' +
                                    '<td>' + formatTotalTime(attendance.totalTime) + '</td>' +
                                    '<td>' +
                                        '<select class="form-control status-dropdown ' + statusClass + '" ' + (attendance.status === 'Approved' ? 'disabled' : '') + '>' +
                                        '<option value="Pending" ' + (attendance.status === 'Pending' ? 'selected' : '') + '>Pending</option>' +
                                        '<option value="Approved" ' + (attendance.status === 'Approved' ? 'selected' : '') + '>Approved</option>' +
                                        '</select>' +
                                    '</td>' +
                                    '</tr>';
                            });

                            html += '</tbody></table>';
                            html += '<button id="submitApproved" class="btn btn-success mt-3" style="display:none;">Submit Approved</button>';

                        } else {
                            html = '<p>No attendance records found.</p>';
                        }

                        $('#attendanceContainer').html(html);

                        // Attach change handler after table is loaded
                        $('.status-dropdown').change(function () {
                            var selected = $(this).val();
                            $(this).removeClass('status-approved status-pending');
                            if (selected === 'Approved') {
                                $(this).addClass('status-approved');
                            } else {
                                $(this).addClass('status-pending');
                            }

                            // Show button if any dropdown has "Approved"
                            let anyApproved = false;
                            $('.status-dropdown').each(function () {
                                if ($(this).val() === 'Approved') {
                                    anyApproved = true;
                                }
                            });

                            if (anyApproved) {
                                $('#submitApproved').show();
                            } else {
                                $('#submitApproved').hide();
                            }
                        });

                        // Immediately trigger change to check initial status
                        $('.status-dropdown').trigger('change');
                    },
                    error: function () {
                        alert('Error loading attendance data.');
                    }
                });
            } else {
                $('#attendanceContainer').html('');
            }
        });

        // Handle button click inside container (delegated event)
        $('#attendanceContainer').on('click', '#submitApproved', function () {
            const approvedIds = [];

            $('#attendanceContainer table tbody tr').each(function () {
                const status = $(this).find('.status-dropdown').val();
                const id = $(this).data('id');
                if (status === 'Approved') {
                    approvedIds.push(id);
                }
            });

            if (approvedIds.length === 0) {
                alert("No records marked as Approved.");
                return;
            }

            $.ajax({
                url: '/Employee/SubmitApprovedAttendance',
                type: 'POST',
                contentType: 'application/json',
                    data: JSON.stringify({
                        userId: $('#userDropdown').val(),
                        approvedIds: approvedIds
                    }),
                    success: function (data) {
        alert('Approved attendance submitted successfully!');

        var html = '';
        if (data && data.length > 0) {
            html += '<table class="table table-striped table-bordered">';
            html += '<thead><tr>' +
                '<th>Date</th>' +
                '<th>Day</th>' +
                '<th>In Time</th>' +
                '<th>Out Time</th>' +
                '<th>Total Time</th>' +
                '<th>Status</th>' +
                '</tr></thead>';
            html += '<tbody>';

            data.forEach(function (attendance) {
                var statusClass = attendance.status === 'Approved' ? 'status-approved' : 'status-pending';

                html += '<tr data-id="' + attendance.id + '">' +
                    '<td>' + formatDate(attendance.date) + '</td>' +
                    '<td>' + attendance.day + '</td>' +
                    '<td>' + formatTime(attendance.inTime) + '</td>' +
                    '<td>' + formatTime(attendance.outTIme) + '</td>' +
                    '<td>' + formatTotalTime(attendance.totalTime) + '</td>' +
                    '<td>' +
                        '<select class="form-control status-dropdown ' + statusClass + '" ' + (attendance.status === 'Approved' ? 'disabled' : '') + '>' +
                        '<option value="Pending" ' + (attendance.status === 'Pending' ? 'selected' : '') + '>Pending</option>' +
                        '<option value="Approved" ' + (attendance.status === 'Approved' ? 'selected' : '') + '>Approved</option>' +
                        '</select>'
                         +
                    '</td>' +
                    '</tr>';
            });

            html += '</tbody></table>';
            html += '<button id="submitApproved" class="btn btn-success mt-3" style="display:none;">Submit Approved</button>';
        } else {
            html = '<p>No attendance records found.</p>';
        }

        $('#attendanceContainer').html(html);

        // Re-bind the change event to the new dropdowns
        $('.status-dropdown').change(function () {
            var selected = $(this).val();
            $(this).removeClass('status-approved status-pending');
            if (selected === 'Approved') {
                $(this).addClass('status-approved');
            } else {
                $(this).addClass('status-pending');
            }

            let anyApproved = false;
            $('.status-dropdown').each(function () {
                if ($(this).val() === 'Approved') {
                    anyApproved = true;
                }
            });

            if (anyApproved) {
                $('#submitApproved').show();
            } else {
                $('#submitApproved').hide();
            }
        }).trigger('change');
    },
                error: function () {
                    alert('Error submitting approved attendance.');
                }
            });
        });

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString();
        }

        function formatTime(timeStr) {
            const time = new Date(timeStr);
            return time.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }
    });
</script>

